# 慢性乙型肝炎治疗效果分析综合报告

## 研究概述

### 研究背景
本研究旨在评估中西医结合疗法（中药联合抗病毒治疗）与单纯抗病毒治疗在慢性乙型肝炎（CHB）患者中的疗效差异。

### 数据概况
- **总样本量**：272例患者
- **治疗组**：149例（中药联合抗病毒治疗）
- **对照组**：123例（单纯抗病毒治疗）
- **协变量**：11个基线特征变量
- **结局变量**：9对治疗前后指标（ALT、AST、肝硬度等）

### 协变量列表
| 变量名 | 含义 |
|--------|------|
| 性别 | 患者性别 |
| 年龄 | 患者年龄 |
| 病程(月) | 疾病持续时间 |
| 治疗前HBVDNA定量(copies/ml) | 乙肝病毒载量 |
| 治疗前ALT(U/L) | 谷丙转氨酶 |
| 治疗前AST(U/L) | 谷草转氨酶 |
| 治疗前肝硬度(kPa) | 肝脏纤维化程度 |
| 治疗前白蛋白(g/L) | 血清白蛋白水平 |
| 治疗前HBsAg定量(IU/ml) | 乙肝表面抗原定量 |
| 治疗前HBeAg定量(S/CO) | 乙肝e抗原定量 |
| 治疗前HBcrAg定量(kU/ml) | 乙肝核心相关抗原定量 |

---

## 方法一：倾向性得分匹配（PSM）

### 方法原理
倾向性得分匹配通过估计每个个体接受治疗的概率（倾向性得分），将治疗组和对照组中倾向性得分相近的个体进行配对，从而减少混杂偏倚。

### 计算公式

#### 1. 倾向性得分估计（Logistic回归）

$$
e(X_i) = P(T_i = 1 | X_i) = \frac{1}{1 + e^{-(\beta_0 + \beta_1 X_{i1} + \beta_2 X_{i2} + \cdots + \beta_p X_{ip})}}
$$

其中：
- $e(X_i)$：个体 $i$ 的倾向性得分
- $T_i$：治疗指示变量（1=治疗组，0=对照组）
- $X_i$：协变量向量
- $\beta$：回归系数

#### 2. 最近邻匹配距离

$$
d(i, j) = |e(X_i) - e(X_j)|
$$

对于治疗组中的每个个体 $i$，选择对照组中使 $d(i, j)$ 最小的个体 $j$ 进行配对。

#### 3. 标准化均值差（SMD）

$$
SMD = \frac{\bar{X}_{treatment} - \bar{X}_{control}}{\sqrt{\frac{S^2_{treatment} + S^2_{control}}{2}}}
$$

其中：
- $\bar{X}$：各组均值
- $S^2$：各组方差
- 判断标准：$|SMD| < 0.1$ 表示平衡良好

### 分析结果

| 指标 | 数值 |
|------|------|
| 匹配前治疗组样本 | 149 |
| 匹配前对照组样本 | 123 |
| 成功匹配对数 | 67 |
| 匹配成功率 | 45.3% |
| 平衡协变量数 | 6/11 (54.5%) |

#### 协变量平衡情况
| 协变量 | 匹配前SMD | 匹配后SMD | 是否平衡 |
|--------|-----------|-----------|----------|
| 性别 | 0.023 | 0.015 | ✓ |
| 年龄 | -0.178 | -0.026 | ✓ |
| 病程(月) | -0.064 | -0.010 | ✓ |
| 治疗前HBVDNA定量 | -0.023 | -0.047 | ✓ |
| 治疗前ALT | 0.141 | 0.031 | ✓ |
| 治疗前AST | 0.178 | 0.075 | ✓ |
| 治疗前肝硬度 | 0.154 | **-0.176** | ✗ |
| 治疗前白蛋白 | -0.062 | **0.103** | ✗ |
| 治疗前HBsAg定量 | -0.091 | **0.140** | ✗ |
| 治疗前HBeAg定量 | 0.099 | **-0.290** | ✗ |
| 治疗前HBcrAg定量 | -0.009 | **-0.230** | ✗ |

#### 结局分析
| 结局变量 | 治疗组变化 | 对照组变化 | P值 | 显著性 |
|----------|------------|------------|-----|--------|
| ALT变化 | -14.36 | -11.51 | 0.701 | 否 |
| AST变化 | -1.72 | 0.25 | 0.698 | 否 |
| 肝硬度变化 | -2.25 | -2.07 | 0.697 | 否 |

### 方法评价
- **优点**：实施简单，概念直观
- **局限**：匹配成功率较低，部分协变量平衡不佳
- **结论**：未发现显著治疗效果差异

---

## 方法二：熵平衡匹配（Entropy Balancing）

### 方法原理
熵平衡通过对对照组样本重新加权，使得加权后的对照组协变量矩与治疗组精确匹配，同时保持权重尽可能接近均匀分布（最大化熵）。

### 计算公式

#### 1. 权重优化目标函数

最小化权重的相对熵：

$$
\min_{w_i} \sum_{i:T_i=0} w_i \ln\left(\frac{w_i}{q_i}\right)
$$

其中 $q_i = \frac{1}{n_0}$ 为基准权重。

#### 2. 矩平衡约束（一阶矩）

$$
\sum_{i:T_i=0} w_i X_{ik} = \bar{X}_{1k}, \quad k = 1, 2, \ldots, p
$$

确保加权后的对照组均值等于治疗组均值。

#### 3. 权重归一化约束

$$
\sum_{i:T_i=0} w_i = 1
$$

#### 4. 非负约束

$$
w_i \geq 0, \quad \forall i \in \{T_i = 0\}
$$

#### 5. 拉格朗日对偶问题

$$
w_i = \frac{q_i \exp(Z_i' \lambda)}{\sum_{j:T_j=0} q_j \exp(Z_j' \lambda)}
$$

其中 $\lambda$ 为拉格朗日乘子，$Z_i$ 为标准化协变量。

### 分析结果

| 指标 | 数值 |
|------|------|
| 治疗组样本 | 149 |
| 对照组样本（加权） | 123 |
| 权重范围 | [0.985, 1.015] |
| 平衡协变量数 | 3/11 (27.3%) |
| 优化状态 | 未完全收敛 |

#### 协变量平衡情况
| 协变量 | 加权前SMD | 加权后SMD | 是否平衡 |
|--------|-----------|-----------|----------|
| 性别 | 0.023 | 0.023 | ✓ |
| 年龄 | -0.178 | **-0.178** | ✗ |
| 病程(月) | -0.064 | -0.064 | ✓ |
| 治疗前ALT | 0.141 | **0.141** | ✗ |
| 治疗前AST | 0.178 | **0.178** | ✗ |
| 治疗前肝硬度 | 0.154 | **0.154** | ✗ |

#### 结局分析
| 结局变量 | 治疗组均值 | 对照组加权均值 | P值 | 显著性 |
|----------|------------|----------------|-----|--------|
| ALT变化 | -14.38 | -5.90 | 0.186 | 否 |
| AST变化 | -1.70 | 0.50 | 0.459 | 否 |
| 肝硬度变化 | -2.25 | -1.17 | 0.061 | 边缘 |

### 方法评价
- **优点**：理论上可实现精确平衡
- **局限**：本数据集优化未能收敛，权重调整幅度极小
- **结论**：需调整优化参数，当前结果不可靠

---

## 方法三：机器学习增强倾向性得分匹配（ML-PSM）

### 方法原理
使用随机森林替代传统Logistic回归估计倾向性得分，可以自动捕捉非线性关系和变量交互作用。

### 计算公式

#### 1. 随机森林分类概率

$$
\hat{e}(X_i) = \frac{1}{B} \sum_{b=1}^{B} \hat{p}_b(X_i)
$$

其中：
- $B$：决策树数量（本研究 $B = 100$）
- $\hat{p}_b(X_i)$：第 $b$ 棵树对个体 $i$ 属于治疗组的预测概率

#### 2. 单棵决策树节点分裂（基尼不纯度）

$$
Gini(D) = 1 - \sum_{k=1}^{K} p_k^2
$$

$$
\Delta Gini = Gini(D) - \frac{|D_L|}{|D|} Gini(D_L) - \frac{|D_R|}{|D|} Gini(D_R)
$$

选择使 $\Delta Gini$ 最大的分裂点。

#### 3. 特征重要性（Mean Decrease Impurity）

$$
Importance(X_j) = \frac{1}{B} \sum_{b=1}^{B} \sum_{t \in T_b} \mathbb{1}(v_t = j) \cdot \Delta Gini_t \cdot \frac{n_t}{n}
$$

其中：
- $T_b$：第 $b$ 棵树的所有节点
- $v_t$：节点 $t$ 用于分裂的变量
- $n_t$：到达节点 $t$ 的样本数

#### 4. AUC-ROC计算

$$
AUC = \frac{\sum_{i:T_i=1} \sum_{j:T_j=0} \mathbb{1}(\hat{e}(X_i) > \hat{e}(X_j)) + 0.5 \cdot \mathbb{1}(\hat{e}(X_i) = \hat{e}(X_j))}{n_1 \cdot n_0}
$$

### 分析结果

| 指标 | 数值 |
|------|------|
| 模型 | 随机森林 |
| 决策树数量 | 100 |
| AUC | 0.593 |
| 成功匹配对数 | 27 |
| 匹配成功率 | 18.1% |
| 平衡协变量数 | 3/11 (27.3%) |

#### 特征重要性排序
| 排名 | 特征 | 重要性 |
|------|------|--------|
| 1 | 治疗前HBcrAg定量 | 0.128 |
| 2 | 年龄 | 0.124 |
| 3 | 治疗前AST | 0.117 |
| 4 | 治疗前HBsAg定量 | 0.107 |
| 5 | 治疗前肝硬度 | 0.103 |

#### 协变量平衡情况
| 协变量 | 匹配前SMD | 匹配后SMD | 是否平衡 |
|--------|-----------|-----------|----------|
| 性别 | 0.023 | -0.081 | ✓ |
| 年龄 | -0.178 | **-0.164** | ✗ |
| 治疗前ALT | 0.141 | **0.212** | ✗ |
| 治疗前AST | 0.178 | **0.398** | ✗ |
| 治疗前肝硬度 | 0.154 | **0.186** | ✗ |

### 方法评价
- **优点**：可捕捉非线性关系
- **局限**：AUC仅0.593，说明两组本身差异小，模型区分度差；匹配成功率极低
- **结论**：不适合本数据集，因为两组基线已相对可比

---

## 方法四：粗化精确匹配（CEM）

### 方法原理
CEM将连续协变量粗化为离散区间，然后在每个层内进行精确匹配。只保留治疗组和对照组同时存在的层。

### 计算公式

#### 1. 协变量粗化

对连续变量 $X_k$，定义粗化函数：

$$
C(X_{ik}) = j \quad \text{if} \quad b_{j-1} < X_{ik} \leq b_j
$$

其中 $\{b_0, b_1, \ldots, b_J\}$ 为分界点，可基于分位数设定。

本研究使用的粗化策略：
- 年龄：5个区间（按分位数）
- 病程：3个区间
- ALT/AST：3个区间
- 肝硬度：3个区间

#### 2. 层定义

$$
S(i) = (C(X_{i1}), C(X_{i2}), \ldots, C(X_{ip}))
$$

具有相同 $S(i)$ 的个体属于同一层。

#### 3. 匹配规则

保留同时满足以下条件的层：

$$
\text{Stratum } s \text{ is valid if } n_{1s} > 0 \text{ and } n_{0s} > 0
$$

其中 $n_{1s}$ 和 $n_{0s}$ 分别为该层中的治疗组和对照组样本数。

#### 4. CEM权重

$$
w_i = 
\begin{cases}
1 & \text{if } T_i = 1 \text{ and stratum is valid} \\
\frac{n_1}{n_0} \cdot \frac{n_{0s}}{n_{1s}} & \text{if } T_i = 0 \text{ and stratum is valid} \\
0 & \text{otherwise}
\end{cases}
$$

#### 5. L1不平衡度量

$$
\mathcal{L}_1 = \frac{1}{2} \sum_{s} |f_{1s} - f_{0s}|
$$

其中 $f_{1s}$ 和 $f_{0s}$ 为各组在层 $s$ 中的频率分布。

### 分析结果

| 指标 | 数值 |
|------|------|
| 使用协变量数 | 5（避免维度灾难） |
| 总层数 | 45 |
| 有效层数（同时包含两组） | 26 |
| 匹配后总样本 | 174 |
| 匹配成功率 | 63.9% |
| 平衡协变量数 | 9/11 (81.8%) |

#### 使用的核心协变量
1. 年龄
2. 治疗前ALT
3. 治疗前AST
4. 治疗前肝硬度
5. 治疗前白蛋白

#### 协变量平衡情况
| 协变量 | 匹配前SMD | 匹配后SMD | 是否平衡 |
|--------|-----------|-----------|----------|
| 性别 | 0.023 | 0.043 | ✓ |
| 年龄 | -0.178 | -0.021 | ✓ |
| 病程(月) | -0.064 | -0.086 | ✓ |
| 治疗前HBVDNA定量 | -0.023 | 0.036 | ✓ |
| 治疗前ALT | 0.141 | 0.066 | ✓ |
| 治疗前AST | 0.178 | 0.053 | ✓ |
| 治疗前肝硬度 | 0.154 | 0.027 | ✓ |
| 治疗前白蛋白 | -0.062 | 0.055 | ✓ |
| 治疗前HBsAg定量 | -0.091 | **-0.129** | ✗ |
| 治疗前HBeAg定量 | 0.099 | 0.050 | ✓ |
| 治疗前HBcrAg定量 | -0.009 | **-0.109** | ✗ |

#### 结局分析
| 结局变量 | 治疗组变化 | 对照组变化 | 组间差异 | P值 | 显著性 |
|----------|------------|------------|----------|-----|--------|
| ALT变化 | -18.04 | -7.59 | -10.45 | 0.127 | 否 |
| AST变化 | -3.30 | 1.20 | -4.50 | 0.159 | 否 |
| **肝硬度变化** | **-2.50** | **-0.91** | **-1.59** | **0.042** | **是** |
| 白蛋白变化 | 1.09 | 0.64 | 0.45 | 0.408 | 否 |

### 方法评价
- **优点**：平衡效果最佳（81.8%），样本保留率高，发现显著结果
- **局限**：需手动选择粗化变量和分箱数
- **结论**：**中药联合治疗在改善肝硬度方面显著优于单纯抗病毒治疗（P=0.042）**

---

## 方法五：双重差分法（DID）

### 方法原理
DID通过比较治疗组和对照组在治疗前后的变化差异，消除组间固定差异和时间趋势的影响。

### 计算公式

#### 1. 基本DID模型

$$
Y_{it} = \alpha + \beta_1 \cdot T_i + \beta_2 \cdot Post_t + \beta_3 \cdot (T_i \times Post_t) + \epsilon_{it}
$$

其中：
- $Y_{it}$：个体 $i$ 在时点 $t$ 的结局
- $T_i$：治疗组指示变量（1=治疗组，0=对照组）
- $Post_t$：时期指示变量（1=治疗后，0=治疗前）
- $\beta_3$：**DID估计量**，即治疗效应

#### 2. DID估计量的含义

$$
\hat{\beta}_3 = (\bar{Y}_{1,post} - \bar{Y}_{1,pre}) - (\bar{Y}_{0,post} - \bar{Y}_{0,pre})
$$

即：治疗组的前后变化 - 对照组的前后变化

#### 3. 带协变量的DID模型

$$
Y_{it} = \alpha + \beta_1 T_i + \beta_2 Post_t + \beta_3 (T_i \times Post_t) + \gamma' X_i + \epsilon_{it}
$$

#### 4. 平行趋势假设检验

DID的核心假设是：如果没有治疗，两组的时间趋势应该平行。

由于只有两个时点，我们通过基线可比性来近似检验：

$$
H_0: \bar{Y}_{1,pre} = \bar{Y}_{0,pre}
$$

使用t检验或Mann-Whitney U检验。

### 分析结果

| 指标 | 数值 |
|------|------|
| 治疗组样本 | 149 |
| 对照组样本 | 123 |
| 总观测（长格式） | 544 (272×2) |
| 显著DID估计数 | 0/9 |
| 基线可比指标数 | 4/9 (44.4%) |

#### 基线可比性检验
| 指标 | 治疗组基线均值 | 对照组基线均值 | P值 | 可比性 |
|------|----------------|----------------|-----|--------|
| ALT | 51.69 | 44.11 | 0.128 | ✓ |
| AST | 40.33 | 34.83 | 0.044 | ✗ |
| 肝硬度 | 9.02 | 8.29 | 0.103 | ✓ |
| 白蛋白 | 45.35 | 45.59 | 0.610 | ✓ |
| HBVDNA | 7.51e6 | 7.84e6 | 0.842 | ✓ |
| HBsAg | 6628 | 8132 | 0.320 | ✓（边缘） |
| HBeAg | 395.8 | 345.9 | 0.531 | ✓ |
| HBcrAg | 5.91e6 | 5.96e6 | 0.976 | ✓ |
| AFP | 5.50 | 4.07 | **0.005** | ✗ |

#### DID分析结果
| 结局 | DID估计 | P值 | 显著性 |
|------|---------|-----|--------|
| ALT | -8.42 | 0.197 | 否 |
| AST | -2.22 | 0.501 | 否 |
| 肝硬度 | -1.07 | 0.063 | 边缘 |
| 白蛋白 | 0.36 | 0.460 | 否 |
| HBVDNA | -3.34e6 | 0.095 | 边缘 |

### 方法评价
- **优点**：可控制不随时间变化的混杂因素
- **局限**：
  1. 仅有2个时点，无法验证平行趋势
  2. 5/9个指标基线不可比，违反平行趋势假设
- **结论**：DID方法不适用于本数据集

---

## 五种方法综合比较

### 匹配效果比较

| 方法 | 匹配样本量 | 平衡协变量比例 | 优化/拟合状态 |
|------|-----------|---------------|---------------|
| PSM | 67对 | 54.5% (6/11) | 正常 |
| EB | 123（加权） | 27.3% (3/11) | 未收敛 |
| ML-PSM | 27对 | 27.3% (3/11) | AUC=0.593 |
| **CEM** | **174** | **81.8% (9/11)** | **最佳** |
| DID | 272（全量） | N/A | 假设不满足 |

### 治疗效果发现

| 方法 | 肝硬度改善P值 | 其他显著发现 |
|------|--------------|-------------|
| PSM | 0.697 | 无 |
| EB | 0.061（边缘） | 无 |
| ML-PSM | 未报告 | 无 |
| **CEM** | **0.042（显著）** | **无** |
| DID | 0.063（边缘） | 无 |

---

## 研究结论

### 主要发现

1. **方法选择**：CEM在本数据集上表现最佳
   - 协变量平衡率最高（81.8%）
   - 样本保留量最大（174例）
   - 唯一发现统计学显著结果

2. **治疗效果**：
   - CEM分析显示：中药联合抗病毒治疗组的肝硬度下降幅度显著大于单纯抗病毒组（-2.50 vs -0.91 kPa，P=0.042）
   - 其他方法未发现显著差异，可能与平衡效果不佳有关

3. **方法适用性评估**：
   - ✅ **CEM**：最适合本数据，推荐使用
   - ⚠️ **PSM**：可用但匹配率偏低
   - ❌ **EB**：需调整优化参数
   - ❌ **ML-PSM**：不适用（组间本身相似）
   - ❌ **DID**：不适用（基线不可比）

### 临床意义

基于CEM分析结果，**中药联合抗病毒治疗可能在逆转肝纤维化方面优于单纯抗病毒治疗**。肝硬度是评估肝纤维化程度的重要指标，其显著改善具有临床意义。

### 研究局限性

1. 仅CEM一种方法发现显著结果，证据强度有限
2. 观察性研究无法完全排除未测量混杂因素
3. 样本量相对较小（272例）
4. 缺乏长期随访数据

### 建议

1. 开展前瞻性随机对照试验验证CEM发现
2. 增加样本量以提高统计效力
3. 纳入更多时点数据以支持DID分析
4. 考虑敏感性分析评估结果稳健性

---

## 附录：统计检验方法

### 两组比较

#### 连续变量
- **正态分布**：独立样本t检验

$$
t = \frac{\bar{X}_1 - \bar{X}_2}{\sqrt{\frac{S_1^2}{n_1} + \frac{S_2^2}{n_2}}}
$$

- **非正态分布**：Mann-Whitney U检验

$$
U = n_1 n_2 + \frac{n_1(n_1+1)}{2} - R_1
$$

#### 分类变量
- 卡方检验或Fisher精确检验

### 正态性检验
- Shapiro-Wilk检验

$$
W = \frac{(\sum_{i=1}^{n} a_i x_{(i)})^2}{\sum_{i=1}^{n} (x_i - \bar{x})^2}
$$

---

*报告生成时间：2025年12月17日*

*分析工具：Python (pandas, numpy, scipy, sklearn, statsmodels, matplotlib)*
